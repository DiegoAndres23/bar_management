{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
    <h2 class="my-4">Lista de Mesas</h2>
    <button class="btn btn-primary mb-3 btn-svg" onclick="addMesa()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
        </svg>
    </button>
    
    <!-- Lista de mesas -->
    <div class="row" id="mesaList">
        {% for mesa in mesas %}
        <div class="col-md-4" id="mesa-{{ mesa.pk }}">
            <div class="card mb-4 mesa-card">
                <div class="card-body">
                    <h5 class="card-title">Mesa {{ mesa.numero }}</h5>
                    <p class="card-text">Capacidad: {{ mesa.capacidad }}</p>
                    <p class="card-text">Estado: {{ mesa.estado }}</p>
                    <select class="form-select mb-3" id="producto-{{ mesa.pk }}">
                        <option value="Aguila">Aguila</option>
                        <option value="Poker">Poker</option>
                        <option value="Club Colombia">Club Colombia</option>
                    </select>
                    <div class="quantity-controls">
                        <button class="btn btn-secondary quantity-btn" onclick="decreaseQuantity({{ mesa.pk }})">-</button>
                        <span id="quantity-{{ mesa.pk }}">1</span>
                        <button class="btn btn-secondary quantity-btn" onclick="increaseQuantity({{ mesa.pk }})">+</button>
                    </div>
                    <button class="btn btn-success" onclick="addPedido({{ mesa.pk }})">Agregar Pedido</button>
                    <button class="btn btn-info" onclick="showPedidos({{ mesa.pk }})">Ver Pedido</button>
                    <button class="btn btn-warning" onclick="pagarCuenta({{ mesa.pk }})">Pagar Cuenta</button>
                    <button class="btn btn-danger" onclick="deleteMesa({{ mesa.pk }})">Eliminar</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Popup -->
<div id="popup" class="popup">
    <div class="popup-content">
        <span class="close" onclick="closePopup()">&times;</span>
        <h2 id="popup-title"></h2>
        <div id="popup-body"></div>
        <button class="btn btn-primary" onclick="closePopup()">Cerrar</button>
    </div>
</div>

<script>
    let mesaCount = {{ mesas|length }}; // Inicializa el contador con el n√∫mero de mesas existentes
    let pedidos = {}; // Objeto para almacenar los pedidos de cada mesa

    function addMesa() {
        mesaCount++;
        const mesaList = document.getElementById('mesaList');
        const newMesa = document.createElement('div');
        newMesa.className = 'col-md-4';
        newMesa.id = `mesa-${mesaCount}`;
        newMesa.innerHTML = `
            <div class="card mb-4 mesa-card">
                <div class="card-body">
                    <h5 class="card-title">Mesa ${mesaCount}</h5>
                    <p class="card-text">Capacidad: <input type="number" class="form-control" placeholder="Capacidad"></p>
                    <p class="card-text">Estado: <input type="text" class="form-control" placeholder="Estado"></p>
                    <select class="form-select mb-3" id="producto-${mesaCount}">
                        <option value="Aguila">Aguila</option>
                        <option value="Poker">Poker</option>
                        <option value="Club Colombia">Club Colombia</option>
                    </select>
                    <div class="quantity-controls">
                        <button class="btn btn-secondary quantity-btn" onclick="decreaseQuantity(${mesaCount})">-</button>
                        <span id="quantity-${mesaCount}">1</span>
                        <button class="btn btn-secondary quantity-btn" onclick="increaseQuantity(${mesaCount})">+</button>
                    </div>
                    <button class="btn btn-success" onclick="addPedido(${mesaCount})">Agregar Pedido</button>
                    <button class="btn btn-info" onclick="showPedidos(${mesaCount})">Ver Pedido</button>
                    <button class="btn btn-warning" onclick="pagarCuenta(${mesaCount})">Pagar Cuenta</button>
                    <button class="btn btn-danger" onclick="deleteMesa(${mesaCount})">Eliminar</button>
                </div>
            </div>
        `;
        mesaList.appendChild(newMesa);
        pedidos[mesaCount] = []; // Inicializa el array de pedidos para la nueva mesa
    }

    function increaseQuantity(mesaId) {
        const quantitySpan = document.getElementById(`quantity-${mesaId}`);
        let quantity = parseInt(quantitySpan.textContent);
        quantity++;
        quantitySpan.textContent = quantity;
    }

    function decreaseQuantity(mesaId) {
        const quantitySpan = document.getElementById(`quantity-${mesaId}`);
        let quantity = parseInt(quantitySpan.textContent);
        if (quantity > 1) {
            quantity--;
            quantitySpan.textContent = quantity;
        }
    }

    function addPedido(mesaId) {
        const productoSelect = document.getElementById(`producto-${mesaId}`);
        const producto = productoSelect.value;
        const quantitySpan = document.getElementById(`quantity-${mesaId}`);
        const quantity = parseInt(quantitySpan.textContent);
        if (!pedidos[mesaId]) {
            pedidos[mesaId] = [];
        }
        pedidos[mesaId].push({ producto, quantity });
        alert(`Producto ${producto} (Cantidad: ${quantity}) agregado a la mesa ${mesaId}`);
    }

    function showPedidos(mesaId) {
        const pedidoList = pedidos[mesaId] || [];
        const pedidoText = pedidoList.map(p => `${p.producto} (Cantidad: ${p.quantity})`).join(', ');
        showPopup(`Pedidos de la mesa ${mesaId}`, pedidoList);
    }

    function pagarCuenta(mesaId) {
        const pedidoList = pedidos[mesaId] || [];
        const pedidoText = pedidoList.map(p => `${p.producto} (Cantidad: ${p.quantity})`).join(', ');
        showPopup(`Total a pagar para la mesa ${mesaId}`, pedidoList);
        pedidos[mesaId] = []; // Reinicia los pedidos de la mesa
    }

    function deleteMesa(id) {
        const mesa = document.getElementById(`mesa-${id}`);
        mesa.remove();
        delete pedidos[id]; // Elimina los pedidos de la mesa
        alert('Eliminar mesa ' + id);
    }

    function showPopup(title, pedidoList) {
        document.getElementById('popup-title').textContent = title;
        const popupBody = document.getElementById('popup-body');
        popupBody.innerHTML = ''; // Clear previous content

        if (pedidoList.length > 0) {
            const table = document.createElement('table');
            table.className = 'table table-striped';
            const thead = document.createElement('thead');
            thead.innerHTML = '<tr><th>Producto</th><th>Cantidad</th></tr>';
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            pedidoList.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${p.producto}</td><td>${p.quantity}</td>`;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            popupBody.appendChild(table);
        } else {
            popupBody.textContent = 'No hay pedidos.';
        }

        document.getElementById('popup').style.display = 'block';
    }

    function closePopup() {
        document.getElementById('popup').style.display = 'none';
    }
</script>
{% endblock %}