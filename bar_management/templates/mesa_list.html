{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
    <h2 class="my-4">Lista de Mesas</h2>
    <button class="btn btn-primary mb-3 btn-svg" onclick="addMesa()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
        </svg>
    </button>
    
    <!-- Lista de mesas -->
    <div class="row" id="mesaList">
        {% for mesa in mesas %}
        <div class="col-md-4" id="mesa-{{ mesa.pk }}">
            <div class="card mb-4 mesa-card">
                <div class="card-body">
                    <h5 class="card-title">Mesa {{ mesa.numero }}</h5>
                    <select class="form-select mb-3" id="producto-{{ mesa.pk }}">
                        <option value="Aguila">Aguila</option>
                        <option value="Poker">Poker</option>
                        <option value="Club Colombia">Club Colombia</option>
                    </select>
                    <div class="quantity-controls">
                        <button class="btn btn-secondary quantity-btn" onclick="decreaseQuantity({{ mesa.pk }})">-</button>
                        <input type="number" id="quantity-{{ mesa.pk }}" value="1" min="1" class="form-control quantity-input">
                        <button class="btn btn-secondary quantity-btn" onclick="increaseQuantity({{ mesa.pk }})">+</button>
                    </div>
                    <button class="btn btn-success" onclick="addPedido({{ mesa.pk }})">Agregar Pedido</button>
                    <button class="btn btn-info" onclick="showPedidos({{ mesa.pk }})">Ver Pedido</button>
                    <button class="btn btn-warning" onclick="pagarCuenta({{ mesa.pk }})">Pagar Cuenta</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Popup -->
<div id="popup" class="popup">
    <div class="popup-content">
        <span class="close" onclick="closePopup()">&times;</span>
        <h2 id="popup-title"></h2>
        <div id="popup-body"></div>
        <button class="btn btn-primary" onclick="closePopup()">Cerrar</button>
    </div>
</div>

<script>
    let mesaCount = {{ mesas|length }}; // Inicializa el contador con el número de mesas existentes
    let pedidos = {}; // Objeto para almacenar los pedidos de cada mesa

    function addMesa() {
        mesaCount++;
        const mesaList = document.getElementById('mesaList');
        const newMesa = document.createElement('div');
        newMesa.className = 'col-md-4';
        newMesa.id = `mesa-${mesaCount}`;
        newMesa.innerHTML = `
            <div class="card mb-4 mesa-card">
                <div class="card-body">
                    <h5 class="card-title">Mesa ${mesaCount}</h5>
                    <select class="form-select mb-3" id="producto-${mesaCount}">
                        <option value="Aguila">Aguila</option>
                        <option value="Poker">Poker</option>
                        <option value="Club Colombia">Club Colombia</option>
                    </select>
                    <div class="quantity-controls">
                        <button class="btn btn-secondary quantity-btn" onclick="decreaseQuantity(${mesaCount})">-</button>
                        <input type="number" id="quantity-${mesaCount}" value="1" min="1" class="form-control quantity-input">
                        <button class="btn btn-secondary quantity-btn" onclick="increaseQuantity(${mesaCount})">+</button>
                    </div>
                    <button class="btn btn-success" onclick="addPedido(${mesaCount})">Agregar Pedido</button>
                    <button class="btn btn-info" onclick="showPedidos(${mesaCount})">Ver Pedido</button>
                    <button class="btn btn-warning" onclick="pagarCuenta(${mesaCount})">Pagar Cuenta</button>
                </div>
            </div>
        `;
        mesaList.appendChild(newMesa);
        pedidos[mesaCount] = []; // Inicializa el array de pedidos para la nueva mesa
    }

    function increaseQuantity(mesaId) {
        const quantityInput = document.getElementById(`quantity-${mesaId}`);
        let quantity = parseInt(quantityInput.value);
        quantity++;
        quantityInput.value = quantity;
    }

    function decreaseQuantity(mesaId) {
        const quantityInput = document.getElementById(`quantity-${mesaId}`);
        let quantity = parseInt(quantityInput.value);
        if (quantity > 1) {
            quantity--;
            quantityInput.value = quantity;
        }
    }

    function addPedido(mesaId) {
        const productoSelect = document.getElementById(`producto-${mesaId}`);
        const producto = productoSelect.value;
        const quantityInput = document.getElementById(`quantity-${mesaId}`);
        const quantity = parseInt(quantityInput.value);
        if (!pedidos[mesaId]) {
            pedidos[mesaId] = [];
        }
        pedidos[mesaId].push({ producto, quantity });
        alert(`Producto ${producto} (Cantidad: ${quantity}) agregado a la mesa ${mesaId}`);
    }

    function showPedidos(mesaId) {
        const pedidoList = pedidos[mesaId] || [];
        showPopup(`Pedidos de la mesa ${mesaId}`, pedidoList, mesaId);
    }

    function pagarCuenta(mesaId) {
        const pedidoList = pedidos[mesaId] || [];
        const total = pedidoList.reduce((sum, pedido) => sum + pedido.quantity, 0); // Calcula el total (puedes ajustar esto según los precios)
        registrarPago(mesaId, total);
        showPopup(`Total a pagar para la mesa ${mesaId}`, pedidoList, mesaId);
        pedidos[mesaId] = []; // Reinicia los pedidos de la mesa
    }

    function registrarPago(mesaId, total) {
        fetch("{% url 'registrar_pago' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ mesa_id: mesaId, total: total })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log(`Pago registrado para la mesa ${mesaId}: ${total} items`);
            } else {
                console.error('Error al registrar el pago');
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function showPopup(title, pedidoList, mesaId) {
        document.getElementById('popup-title').textContent = title;
        const popupBody = document.getElementById('popup-body');
        popupBody.innerHTML = ''; // Clear previous content

        if (pedidoList.length > 0) {
            const table = document.createElement('table');
            table.className = 'table table-striped';
            const thead = document.createElement('thead');
            thead.innerHTML = '<tr><th>Producto</th><th>Cantidad</th><th>Acciones</th></tr>';
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            pedidoList.forEach((p, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${p.producto}</td><td>${p.quantity}</td><td><button class="btn btn-danger" onclick="deletePedido(${mesaId}, ${index})">Eliminar</button></td>`;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            popupBody.appendChild(table);
        } else {
            popupBody.textContent = 'No hay pedidos.';
        }

        document.getElementById('popup').style.display = 'block';
    }

    function deletePedido(mesaId, index) {
        pedidos[mesaId].splice(index, 1);
        showPedidos(mesaId); // Actualiza el popup después de eliminar el pedido
    }

    function closePopup() {
        document.getElementById('popup').style.display = 'none';
    }
</script>
{% endblock %}

<style>
.sidebar {
    height: 100vh;
    width: 250px;
    position: fixed;
    left: 0;
    top: 0;
    background-color: #343a40;
    padding-top: 20px;
}
.sidebar a {
    padding: 10px 15px;
    text-decoration: none;
    font-size: 18px;
    color: white;
    display: block;
}
.sidebar a:hover {
    background-color: #495057;
}
.content {
    margin-left: 260px;
    padding: 20px;
}

.mesa-card {
    height: 300px; /* Ajusta la altura según tus necesidades */
    overflow-y: auto; /* Permite el desplazamiento vertical si el contenido es demasiado grande */
}

.btn-svg {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    width: 40px; /* Ajusta el ancho según tus necesidades */
    height: 40px; /* Ajusta la altura según tus necesidades */
    padding: 0;
}

.quantity-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
}

.quantity-controls button {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin: 0 5px;
}

.quantity-controls .quantity-input {
    width: 50px; /* Ajusta el ancho según tus necesidades */
    text-align: center;
    margin: 0 5px;
}

.quantity-controls input[type="number"] {
    margin: 0;
    width: 70px;
}
/* Popup styles */
.popup {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
}

.popup-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
    text-align: center;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

.btn-danger {
    background-color: red;
    color: white;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
}

.btn-danger:hover {
    background-color: darkred;
}
</style>